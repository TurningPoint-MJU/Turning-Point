# 시각화 기능 상세 가이드

## 개요

이 프로젝트는 경기 흐름 분석을 위한 3가지 주요 시각화 기능을 제공합니다:
1. 모멘텀 곡선 그래프
2. 선수 위치 히트맵
3. 선수 움직임 그래프

## 1. 모멘텀 곡선 그래프

### 기능
경기 전체의 흐름을 시간에 따라 시각화합니다.

### 생성 방법

```python
from src.visualization.plotter import plot_momentum_curve
from src.analysis.turning_point import detect_turning_points

turning_points = detect_turning_points(match_data)
plot_momentum_curve(match_data, turning_points, "momentum_curve.png")
```

### 그래프 축 설명

#### 가로축 (X축): 경기 시간
- **범위**: 0분 ~ 90분
- **단위**: 5분 간격으로 표시
- **의미**: 경기가 진행된 시간을 나타냄
  - 0분: 경기 시작
  - 45분: 전반 종료
  - 90분: 경기 종료
- **데이터 포인트**: 5분 단위로 모멘텀 점수 계산 (0, 5, 10, ..., 85, 90분)

#### 세로축 (Y축): 경기 흐름 점수 (모멘텀 점수)
- **범위**: -110 ~ +110 (일반적으로)
- **단위**: 점수 (점수 단위)
- **의미**: 홈팀과 원정팀의 상대적 우세도를 나타내는 종합 지표
  - **양수 (+값)**: 홈팀이 우세한 상태
    - 값이 클수록 홈팀이 더 압도적으로 우세
    - 예: +50은 홈팀이 상당히 우세, +100은 홈팀이 매우 우세
  - **음수 (-값)**: 원정팀이 우세한 상태
    - 값이 작을수록(절댓값이 클수록) 원정팀이 더 압도적으로 우세
    - 예: -50은 원정팀이 상당히 우세, -100은 원정팀이 매우 우세
  - **0**: 양 팀이 균형을 이루는 상태
- **계산 방법**: 
  - 5분 구간별로 홈팀과 원정팀의 지표를 비교
  - 포함 지표: 점유율, 슈팅, xG(기대득점), 패스 성공률, 수비 라인 위치 등
  - 홈팀 지표가 우수하면 양수, 원정팀 지표가 우수하면 음수

### 그래프 요소

- **파란색 영역**: 홈팀이 우세한 구간 (모멘텀 점수 > 0)
  - 곡선이 0선 위에 있는 구간
  - 영역이 넓을수록 홈팀이 오랫동안 우세했음을 의미
- **빨간색 영역**: 원정팀이 우세한 구간 (모멘텀 점수 < 0)
  - 곡선이 0선 아래에 있는 구간
  - 영역이 넓을수록 원정팀이 오랫동안 우세했음을 의미
- **검은 점선 (0선)**: 경기 주도권이 균형인 상태 (모멘텀 점수 = 0)
  - 곡선이 이 선을 교차할 때 주도권이 바뀜
- **파란색 곡선**: 시간에 따른 모멘텀 점수 변화
  - 곡선의 기울기가 급격할수록 주도권 변화가 빠름
  - 곡선이 위로 올라갈수록 홈팀이 유리해짐
  - 곡선이 아래로 내려갈수록 원정팀이 유리해짐
- **별표 마커**: 탐지된 변곡점
  - 초록색: 홈팀에 유리한 변곡점 (홈팀이 유리해지는 전환점)
  - 주황색: 원정팀에 유리한 변곡점 (원정팀이 유리해지는 전환점)
- **노란색 박스**: 변곡점 시각 표시 (몇 분에 발생했는지)

### 스타일 개선 (2024년 최신)
- **seaborn 스타일 적용**: `whitegrid` 스타일과 `husl` 팔레트 사용
- **그래프 크기**: `figsize=(12, 8)`로 확대
- **선 그래프**: 부드러운 선 (`lw=2.5`), 마커 추가 (`marker='o'`, `markersize=6`)
- **막대 그래프**: 중첩 방지 (`width=3`, `alpha=0.7`)
- **변곡점 강조**: 노란색(`gold`) 산점도 마커 (`s=200`), 화살표 주석 추가
- **레이블/범례**: 제목 `fontsize=16`, 축 레이블 `fontsize=14`, 범례 최적화

### 해석 방법

1. **전체 경기 흐름 파악**
   - 파란색 영역이 넓을수록 홈팀이 경기를 주도
   - 빨간색 영역이 넓을수록 원정팀이 경기를 주도
   - 두 영역이 비슷하면 경기가 팽팽했음을 의미

2. **주도권 변화 시점**
   - 곡선이 0선을 교차하는 지점에서 주도권이 바뀜
   - 교차가 많을수록 경기 흐름이 자주 바뀜

3. **변곡점 분석**
   - 변곡점이 많은 구간은 경기 흐름이 자주 바뀌는 구간
   - 변곡점 근처에서 중요한 사건(골, 퇴장, 전술 변경 등)이 발생했을 가능성

4. **우세도 강도**
   - 모멘텀 점수의 절댓값이 클수록 한 팀이 압도적으로 우세
   - +100에 가까우면 홈팀이 매우 우세
   - -100에 가까우면 원정팀이 매우 우세
   - ±20 이내면 양 팀이 비슷한 수준

5. **시간대별 분석**
   - 전반(0-45분): 초반 전술과 적응도 확인
   - 후반(45-90분): 체력과 전술 변화 확인
   - 종료 직전(80-90분): 결정적 순간 확인

## 2. 선수 위치 히트맵

### 기능
변곡점 시점의 선수 위치 분포, 패스 연결, 슈팅 방향, 공격/수비 라인을 한눈에 보여줍니다.

### 생성 방법

```python
from src.visualization.plotter import plot_player_heatmap
from src.analysis.player_analysis import extract_player_activities

player_activities = extract_player_activities(match_data, turning_point)
plot_player_heatmap(match_data, turning_point, player_activities, "heatmap.png")
```

### 그래프 요소

#### 배경 히트맵
- **색상**: 노란색 → 주황색 → 빨간색 (활동 빈도 증가)
- **의미**: 선수들이 자주 활동한 위치

#### 패스 연결선 및 네트워크
- **파란색 얇은 화살표**: 성공한 패스
  - 얇은 파란색 실선 화살표로 표시
  - 앞쪽 10개는 조금 더 진하게, 나머지는 더 투명하게 표시
  - 최대 20개 표시
- **회색 얇은 화살표**: 실패한 패스 또는 비중 낮은 패스
  - 얇은 회색 실선 화살표로 표시
  - 투명도 낮게 표시
  - 최대 10개 표시

#### 슈팅 표시
- **원형 마커**: 슈팅 위치
  - 크기와 색상은 xG에 비례
  - 진한 주황 (xG ≥ 0.3): 큰 원 (120px)
  - 주황 (xG ≥ 0.15): 중간 원 (90px)
  - 노랑 (xG < 0.15): 작은 원 (70px)
- **화살표**: 슈팅 방향 (골대 방향)
  - 전반/후반 및 홈/원정팀에 따라 골대 위치 자동 결정
  - 전반: 홈팀 → 오른쪽(x=100), 원정팀 → 왼쪽(x=0)
  - 후반: 홈팀 → 왼쪽(x=0), 원정팀 → 오른쪽(x=100)
  - xG에 따라 화살표 굵기와 색상 조정

#### 공격/수비 라인
- **파란색 세로선**: 공격 라인
  - 공격 이벤트(슈팅, 패스)의 평균 x 좌표
  - 라인이 오른쪽(골대 방향)에 있을수록 공격적
  - 필드 상단에 "공격 라인↑" 텍스트 표시
- **청록색 세로선**: 수비 라인
  - 수비 이벤트의 평균 x 좌표
  - 라인이 왼쪽에 있을수록 수비적
  - 필드에는 숫자 없이 색상과 두께로만 표시

#### 주요 선수 표시
- **개별 히트맵**: 각 선수별로 색상이 다른 히트맵으로 활동 영역 표시
  - 각 선수는 다른 색상으로 구분 (파란색, 청록색, 하늘색 등 차가운색 계열)
  - 히트맵 색상이 진할수록 해당 선수가 그 위치에서 많이 활동
  - 원형 영역이 아닌 실제 활동 밀도로 표시
- **색상 원 마커**: 선수 평균 위치
  - 원의 크기는 영향도 점수에 비례 (영향도가 높을수록 큰 원)
  - 원 안에 선수 번호(1, 2, 3, 4, 5) 표시
  - 상위 3명 주요 선수는 굵은 테두리와 halo 효과로 강조
- **오른쪽 사이드 패널**: 통일된 레이아웃으로 구성
  - **범례 박스**: 기호와 의미 설명
    - ★: 변곡점 이벤트(슈팅/결정적 패스)
    - ●: 파란 원(수비수), 연두색 원(공격수)
    - →: 파란 실선 화살표(성공 패스), 회색 점선 화살표(비중 낮은/예상 패스)
    - →: 노란/주황 화살표(슈팅 방향, xG에 따라 색상)
  - **선수 통계 표**: 번호, 선수명, 슈팅, 패스, 수비, xG, 영향도 점수
    - 각 선수별 색상으로 행 구분 (채도 낮춤)
    - 주요 수치(영향도 1위, 슈팅 수 상위)는 굵게 표시
  - **변곡점 설명 박스**: 각 변곡점 이벤트에 대한 한 줄 요약
    - 번호(①, ②, ③...)와 함께 핵심 정보만 표시
    - 가장 중요한 텍스트 카드로 진한 테두리와 굵은 제목
  - **전체 설명 박스**: 경기 흐름 요약 및 공격/수비 라인 정보
    - 2-3줄로 요약하여 표시
    - 변곡점 설명보다 낮은 위계로 연한 테두리와 작은 제목
  - 모든 박스는 동일한 좌측 정렬선과 폭으로 통일된 세로 컬럼 구성

#### 필드 라인
- **중앙선**: 흰색 점선 (x = 50)
- **페널티 박스**: 흰색 사각형 (대략적 위치)

#### 좌표계 및 눈금
- **X축 (필드 너비)**: 0 (왼쪽 골대) ~ 100 (오른쪽 골대)
  - 필드 하단에 10단위 눈금 표시 (0, 10, 20, ..., 100)
  - 필드 상단에 설명 텍스트 표시
- **Y축 (필드 높이)**: 0 (하단) ~ 100 (상단)
  - 필드 좌측에 10단위 눈금 표시 (0, 10, 20, ..., 100)
  - 필드 상단에 설명 텍스트 표시

#### 골대 팀 이름 표시
- **위치**: 각 골대 상단 (필드 상단, y=99)
- **표시 방식**: 
  - 왼쪽 골대(x=0): 왼쪽 정렬로 팀 이름 표시
  - 오른쪽 골대(x=100): 오른쪽 정렬로 팀 이름 표시
- **전반/후반에 따른 골대 위치**:
  - 전반: 왼쪽 골대 = 홈팀, 오른쪽 골대 = 원정팀
  - 후반: 왼쪽 골대 = 원정팀, 오른쪽 골대 = 홈팀

### 해석 방법

1. **히트맵 색상**: 어느 지역에서 가장 많은 활동이 있었는지 확인
2. **패스 연결선**: 공격 패턴과 패스 성공률 파악
   - 파란색 화살표가 많을수록 공격이 활발했음을 의미
   - 패스 방향으로 공격 흐름 파악 가능
3. **슈팅 위치 및 방향**: 위험한 슈팅이 어디서 나왔는지 확인
   - 슈팅 화살표 방향으로 골대 위치 확인
   - xG 값으로 슈팅의 위험도 파악
4. **공격/수비 라인**: 팀의 전술적 위치 형성 상태 파악
   - 라인 간격으로 압박 강도 확인
5. **선수 위치**: 주요 선수들이 어디서 활동했는지 확인
   - 개별 히트맵으로 각 선수의 활동 영역 파악
6. **우측 패널 정보**: 
   - 범례로 기호 의미 확인
   - 선수 통계로 주요 기여자 식별
   - 변곡점 설명으로 각 이벤트의 의미 파악
   - 전체 설명으로 경기 흐름 요약 확인
7. **좌표계 활용**: x, y축 눈금으로 정확한 위치 파악

## 3. 선수 움직임 그래프

### 기능
주요 선수들의 개별 활동 패턴을 히트맵과 이벤트 마커로 시각화합니다.

### 생성 방법

```python
from src.visualization.plotter import plot_player_movements
from src.analysis.player_analysis import extract_player_activities, get_key_players

player_activities = extract_player_activities(match_data, turning_point)
plot_player_movements(match_data, turning_point, player_activities, top_n=5, save_path="movements.png")
```

### 그래프 구성

각 선수마다 개별 서브플롯을 생성합니다.

#### 배경 히트맵
- **색상**: 노란색 → 주황색 → 빨간색
- **의미**: 해당 선수의 위치 분포 (활동 빈도)

#### 이벤트 마커
- **빨간 별**: 슈팅 위치
- **청록 사각형**: 성공한 패스 위치
- **주황 X**: 실패한 패스 위치
- **초록 삼각형**: 수비 액션 위치

#### 선수 통계
각 서브플롯 제목에 다음 정보 표시:
- 슈팅 횟수
- 패스 횟수
- 수비 액션 횟수
- xG 기여도
- 영향도 점수

#### 범례
첫 번째 서브플롯에 범례 표시:
- 각 마커의 의미 설명

### 해석 방법

1. **히트맵**: 선수가 주로 활동한 영역 확인
2. **슈팅 위치**: 선수의 공격 기여도 파악
3. **패스 위치**: 선수의 패스 성공률과 위치 확인
4. **수비 액션**: 선수의 수비 기여도 파악
5. **통계 비교**: 여러 선수의 통계를 비교하여 주요 기여자 식별

## 한글 폰트 설정

모든 그래프는 한글을 지원하는 폰트를 자동으로 설정합니다.

**지원 폰트 (우선순위)**:
1. AppleGothic (macOS)
2. NanumGothic
3. Malgun Gothic
4. NanumBarunGothic

폰트를 찾지 못한 경우 경고 메시지가 표시되며, 한글이 깨질 수 있습니다.

## 그래프 저장 옵션

### 해상도
- 기본 DPI: 300 (고해상도)
- `bbox_inches='tight'`: 여백 최소화
- `pad_inches=0.2`: 히트맵의 경우 약간의 여백 추가

### 파일 형식
- PNG 형식으로 저장
- 투명도 지원

## 사용 팁

1. **히트맵 해석**: 색상이 진한 영역이 해당 시점의 핵심 활동 지역
2. **패스 패턴**: 패스 연결선이 많을수록 공격이 활발했음을 의미
   - 파란색 화살표의 방향으로 공격 흐름 파악
3. **슈팅 방향**: 슈팅 화살표 방향으로 어느 골대를 향해 슈팅했는지 확인
   - 전반/후반에 따라 골대 위치가 바뀌므로 주의
4. **라인 비교**: 공격 라인과 수비 라인의 거리가 가까울수록 압박이 강함
5. **선수 비교**: 여러 변곡점의 히트맵을 비교하여 선수들의 역할 변화 파악
6. **시간대별 비교**: 전반/후반 히트맵을 비교하여 전술 변화 확인
7. **좌표 활용**: x, y축 눈금을 활용하여 정확한 위치 파악
8. **우측 패널 활용**: 변곡점 설명과 전체 설명으로 경기 흐름 이해

